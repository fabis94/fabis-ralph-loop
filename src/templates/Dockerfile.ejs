<%= generatedHeader %>
FROM <%= baseImage %>

# === System packages ===
# hadolint ignore=DL3008
RUN apt-get update && apt-get install -y --no-install-recommends \
    vim \
    git \
    curl \
    jq \
    sudo \
    direnv \
<% for (const pkg of systemPackages) { -%>
    <%= pkg %> \
<% } -%>
    && rm -rf /var/lib/apt/lists/*
<% if (installNode) { %>
# === Node.js 22 (base image is not node-based) ===
# hadolint ignore=DL3008,DL3009
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y --no-install-recommends nodejs
<% } -%>
<% if (playwright) { %>
# === Playwright/Chromium dependencies ===
# hadolint ignore=DL3008
RUN apt-get update && apt-get install -y --no-install-recommends \
    chromium \
    fonts-liberation \
    libnss3 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2 \
    libxshmfence1 \
    && rm -rf /var/lib/apt/lists/*
<% } -%>
<% for (const instruction of hooks.rootSetup) { %>
<%= instruction %>
<% } -%>

<% if (createUser) { -%>
# === User setup ===
# hadolint ignore=SC2015
RUN if id -nu 1000 >/dev/null 2>&1; then \
      echo "ERROR: UID 1000 is already taken by user '$(id -nu 1000)' in this base image." && \
      echo "Set container.user to '$(id -nu 1000)' in fabis-ralph-loop.config.ts to reuse it." && \
      exit 1; \
    fi \
    && if getent group 1000 >/dev/null 2>&1; then \
      echo "ERROR: GID 1000 is already taken by group '$(getent group 1000 | cut -d: -f1)' in this base image." && \
      echo "Set container.user to an existing user in fabis-ralph-loop.config.ts." && \
      exit 1; \
    fi \
    && groupadd -g 1000 sandbox \
    && useradd -m -u 1000 -g 1000 -s /bin/bash sandbox \
    && echo 'sandbox ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
<% } else { -%>
# === User setup (reusing existing user from base image) ===
RUN echo '<%= user %> ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers
<% } -%>

# Hook direnv into bash for interactive shells
# SC2016: single quotes are intentional
# hadolint ignore=SC2016
RUN printf 'eval "$(direnv hook bash)" || true\n' >> /etc/bash.bashrc \
    && printf '[ "$PWD" = "/workspace" ] && eval "$(direnv export bash 2>&1)" 2>/dev/null || true\n' >> /etc/bash.bashrc

# Pre-install Ralph loop CLI so it's available immediately (no npx download on first run)
RUN npm install -g fabis-ralph-loop@<%= packageVersion %>
RUN printf '#!/bin/bash\nexec fabis-ralph-loop run "$@"\n' \
    > /usr/local/bin/run-fabis-ralph-loop && chmod +x /usr/local/bin/run-fabis-ralph-loop

WORKDIR /workspace

USER <%= user %>
<% for (const instruction of hooks.userSetup) { %>
<%= instruction %>
<% } %>
# === Claude CLI ===
# hadolint ignore=DL4006
RUN mkdir -p <%= homeDir %>/.claude <%= homeDir %>/.local/share/direnv/allow \
    && printf '{"hasCompletedOnboarding":true,"bypassPermissionsModeAccepted":true}\n' > <%= homeDir %>/.claude.json \
    && curl -fsSL https://claude.ai/install.sh | bash
ENV PATH="<%= homeDir %>/.local/bin:${PATH}"

<% if (playwright) { %>
# === Playwright CLI & MCP pre-install ===
RUN npm install -g @playwright/cli@latest \
    && npx -y @playwright/mcp@latest --help 2>/dev/null || true
<% } %>
# === Environment ===
ENV IS_SANDBOX=1
<% if (playwright) { -%>
ENV PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
<% } %>
# === Entrypoint ===
COPY entrypoint.ts /entrypoint.ts
ENTRYPOINT ["node", "--experimental-strip-types", "/entrypoint.ts"]
CMD ["bash"]
